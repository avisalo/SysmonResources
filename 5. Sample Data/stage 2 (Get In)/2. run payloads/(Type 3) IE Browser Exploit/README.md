# Browser Exploit

## Background
The browser is the "window" to the Internet in a sense. We download various types of files, executables to contents using our browsers. But sometimes, even without downloading anything, bad things can happen.

## Payload
I used quite an [old IE 8 exploit](https://www.rapid7.com/db/modules/exploit/windows/browser/ms11_003_ie_css_import) on a fresh (unpatched) 32bit Win7-SP1 VM. You can find the exploit details within the earlier Rapid7 link. Bug exploitations are typically specific to OS architecture & software component versions. I picked this exploit since it should be reliable on all Windows versions with .NET 2.0.50727 installed, which in this test-case ran well.

## Observations
From the [type 1 & 2 samples](https://github.com/jymcheong/SysmonResources/tree/master/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads), I believe you have seen enough of Parent process spawning new child process scenarios. You should also be familiar with Sysmon Event ID 1 (ProcessCreate) & 3 (Initiated Network Connection) events by now.

For a browser, it shouldn't be too surprising to see **Network Connection** events, for instance log **[line 5](https://github.com/jymcheong/SysmonResources/blob/5fcfa9e99188f2f949e25728ed2a21cb77c7336b/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20IE%20Browser%20Exploit/ms11_003_ie_css%20exploit%20eventlog.txt#L5) to 10**, after which **[line 17](https://github.com/jymcheong/SysmonResources/blob/5fcfa9e99188f2f949e25728ed2a21cb77c7336b/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20IE%20Browser%20Exploit/ms11_003_ie_css%20exploit%20eventlog.txt#L24) to 19**. Afterall, a browser is meant to surf the web. **In my sample, you will see the actual destination but not so in an environment that uses web proxy servers in IE/system settings**.

The most interesting events in this set of logs is the appearance of **Event ID 8 (CreateRemoteThread) in [line 12](https://github.com/jymcheong/SysmonResources/blob/5fcfa9e99188f2f949e25728ed2a21cb77c7336b/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20IE%20Browser%20Exploit/ms11_003_ie_css%20exploit%20eventlog.txt#L12) & [24](https://github.com/jymcheong/SysmonResources/blob/5fcfa9e99188f2f949e25728ed2a21cb77c7336b/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20IE%20Browser%20Exploit/ms11_003_ie_css%20exploit%20eventlog.txt#L24)**. We see that SourceImage is Iexplorer.exe (browser) to explorer.exe as Target. 

This is in fact related or the same as [another sample: Meterpreter Process Migration](https://github.com/jymcheong/SysmonResources/tree/master/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20Meterpreter%20Process%20Migration). For this particular exploit, Metasploit automatically migrates to explorer.exe just in case the browser crashes or is closed by the user.

## Questions

* In an event proxy is in use, how do we reliably link the process to true destination together?
* Does the method for the earlier question take into account of IP changes due to DHCP?
* Any [other process(es) in your environment](https://github.com/jymcheong/SysmonResources/tree/master/5.%20Threat%20Analytics#why-network-monitoring-is-not-enough) that does outbound port 443?
* How often does a browser creates remote thread?
* If the exploit doesn't spawn a new process or creates any remote threads then how can we tell?

The last question is a [priming](https://en.wikipedia.org/wiki/Priming_(psychology)) question & is related to the other tactical aspects of the ALC or MITRE ATT&CK tactics.
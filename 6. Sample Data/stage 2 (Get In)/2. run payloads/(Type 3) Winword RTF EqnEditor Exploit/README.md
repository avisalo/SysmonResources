# Equation Editor Exploit (CVE-2017-11882)
## Background
Equation Editor is a tool in MS-Office suite to create embedded equations. [https://support.office.com/en-us/article/Equation-Editor-6eac7d71-3c74-437b-80d3-c7dea24fdf3f](https://support.office.com/en-us/article/Equation-Editor-6eac7d71-3c74-437b-80d3-c7dea24fdf3f) It will be removed from all versions that have installed the January 2018 Public Update.

It contains a stack buffer overflow vulnerability that allows remote code execution on a vulnerable system: [https://researchcenter.paloaltonetworks.com/2017/12/unit42-analysis-of-cve-2017-11882-exploit-in-the-wild/](https://researchcenter.paloaltonetworks.com/2017/12/unit42-analysis-of-cve-2017-11882-exploit-in-the-wild/)

So what's the big deal? We have macros, DDE & what not. Well, some of the legit mechanisms can be disabled, or it may prompt warning thus require more social engineering (deception) & user intervention (eg. click yes, go, ok). 

Bug exploitation on the other hand, will run automatically & silently... but some exploits may lead to crashes & system instability (eg. blue-screen).

## Payload
One can either generate a payload with [metasploit module](https://www.rapid7.com/db/modules/exploit/windows/fileformat/office_ms17_11882) or [python generator script](https://github.com/jymcheong/SysmonResources/blob/master/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20Winword%20RTF%20EqnEditor%20Exploit/cve2017-11882.py). This exploit is rather stable & reliable.

Why choose this payload from so many other exploits? We have seen a sample that [exploits the browser](https://github.com/jymcheong/SysmonResources/tree/master/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20IE%20Browser%20Exploit) without a file interaction & it performs a [Meterpreter Process Migration](https://github.com/jymcheong/SysmonResources/tree/master/6.%20Sample%20Data/stage%202%20(Get%20In)/2.%20run%20payloads/(Type%203)%20Meterpreter%20Process%20Migration). 

We have also observed from Type 2 samples, questionable code-execution that has a direct Parent -> Child process relationships. 

*So I thought it would be apt to use a sample that is delivered via a weaponised content, but does not cause a direct Parent (word) -> Child (calc.exe) execution.* 

## Observations

* Line 1 tells us Winword process was created, with path to file in CmdLine field. The Winword's ProcessGuid only matches 3 other log lines: 34 (Pipe Created), 41 (Network Initiated) & 43 (Process Terminate). We will come back to line 34 & beyond later.

* Line 2 is a Sysmon Event ID 13 - set value to registry. From the registry path, we can infer that it is related to the file extension .rtf OpenWithList & Winword.exe is added to that list I suppose.

* Line 3 shows termination of a DLLhost.exe, not sure if it is related.

* Line 4 shows Process Creation of EQNEDT32.exe. Now when we take ParentProcessGuid's value *{0EE20E5C-025D-5A3A-0000-00105CC40000} to do a search on this text log, you won't find any ProcessCreate event that shows the first creation of this svchost.exe parent & NOT Winword. It means svchost was create some time much earlier.*

* Line 5 however, shows that Calc.exe is the child of EQNEDT32.exe. An over-simplified description is that this malformed RTF opened in Word, caused EQNEDT32 to spawn a Calculator app, but runs under existing user context, same IntegrityLevel: medium. The Palo Alto Network's analysis is deeper & detailed.

* Line 6 shows Services.exe process created & followed by line 7 to 12 of RawAccess reads by this SYSTEM process.

* Line 13 shows WerFault.exe process created & again followed by RawAccess read from line 14 to 31.

* WerFault terminates at line 32
* EQNEDT32 terminates at line 33
* So now to line 34 which we references at line 1 earlier, Pipe Created event.
* Line 35 shows a SVChost initiating a Network Connection to 255.255.255.255 which is a broadcast on bootps port

* Line 36 shows the same SVCHOST connecting to the same VM via llmr port.

* Line 37 shows OSPPSVC.exe with the path ...OfficeSoftwareProtectionPlatform.. process created. 

* OSSPSVC then makes a RawAccess read in line 38 

* A System process with ProcessGuid {0EE20E5C-0257-5A3A-0000-0010EA030000} (ProcessCreate not within log) broadcast netbios-ns via 192.168.181.255 network connections in line 39 & 40.

* Line 41 switches to Winword making a network connection to a Microsoft owned IP 52.109.2.16 via port 443 presumably via TLS/SSL.

* Line 42 is network connection related to System process with ProcessGuid {0EE20E5C-0257-5A3A-0000-0010EA030000} 

* Line 43 & 44, word & calc terminated as markers I used so as to know where to stop copying logs.

There's really many things going on with this sample. Using calc is a good idea since we know it usually won't do much after launch. Whatever that were between its start is likely due to MS-Office & system's response to a fault.

I inferred from WerFault (line 13) kicked in to read something right after the EqnEdit32 creation. Even for the sequence of Pipe created by Winword followed connecting out, it was to a Microsoft owned IP, unlikely to be directly caused by the exploit. 

If you noticed in line 5, the Cmdline was calc.exe &AAA... this is as per reported by Palo Alto Network's analysis, except in my case, I did not use cmd /c to launch calc.exe. 

Also note that time between line 1 to 5 is merely 1 second apart. If we didn't know about this exploit at all, it is reasonable to attribute this unusual execution sequences to the launching of this document.

## Questions
* What happens if we opened the same payload in Wordpad or Outlook for that matter?

